name: test

on:
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checking out repository
        uses: actions/checkout@v4

      - name: Run test
        shell: bash
        run: |-
          cp -r report report-cp

      - name: Extract values from json and send to github output
        id: report
        shell: bash
        run: |
          ls -la
          chmod +x ./test/report.sh
          ./test/report.sh report-cp/report.json

      - name: Display extracted values
        shell: bash
        run: |
          echo "Status: ${{ steps.report.outputs.status }}"
          echo "Message: ${{ steps.report.outputs.message }}"

      - name: Deploy
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./report-cp

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: report-cp
          path: report-cp
          retention-days: 1

      - name: Dispatch an action and get the run ID and URL
        uses: codex-/return-dispatch@v1
        id: return_dispatch
        with:
          token: ${{ secrets.GITHUB_TOKEN }} # Note this is NOT GITHUB_TOKEN but a PAT
          ref: target_branch # or refs/heads/target_branch
          repo: repository-name
          owner: repository-owner
          workflow: automation-test.yml
          workflow_inputs: '{ "some_input": "value" }' # Optional
          workflow_timeout_seconds: 120 # Default: 300

      - name: Use the output run ID and URL
        run: |
          echo ${{steps.return_dispatch.outputs.run_id}}
          echo ${{steps.return_dispatch.outputs.run_url}}
